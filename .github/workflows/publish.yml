name: Publish

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml

  publish:
    name: Publish to pub.dev
    needs: ci
    permissions:
      id-token: write
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    with:
      environment: pub.dev

  release:
    name: GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
      - name: Extract changelog
        id: changelog
        run: |
          # Extract the section for this version from CHANGELOG.md
          version="${{ steps.version.outputs.version }}"
          changelog=$(awk "/^## ${version//./\\.}/{found=1; next} /^## /{if(found) exit} found{print}" CHANGELOG.md)
          if [ -z "$changelog" ]; then
            changelog="Release ${version}"
          fi
          # Write to file to avoid escaping issues
          echo "$changelog" > /tmp/changelog.txt
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "h3_core ${{ steps.version.outputs.version }}" \
            --notes-file /tmp/changelog.txt
